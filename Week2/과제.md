# 2주 차 과제

<br/>

## 1. Local server 구축 

Window/MacOS 환경에서 Apache PHP MySQL (Bitnami) 이용해 local server 구축하기.

<br/>

- **진행 순서** 

1. bitnami 이용 mapm 설치하기
2. port forwarding 하기 

<br/>

1.

일단 local server를 구축하기 위해서 bitnami에서 제공하는 mapm(macOS, apache, php, mysql)을 설치해야한다. 

설치 과정은 어렵지 않았다. [설치 링크](https://bitnami.com/stack/mamp/installer) 링크로 들어가 mapm을 원하는 version을 다운로드해서 설치하면 된다. 실치가 완료되면 apache와 mysql을 시작하면 local server가 구축 된다. 

<br/>

- bitnami?

bitnami는 다양한 환경에서 애플리케이션을 설치, 배포, 유지하기 위한 통합 설치 패키지를 제공하는 회사이다. 그리고 이런 통합 설치 패키지를 스택이라고 부른다. 

<hr/>

<br/>

2.

Local server을 구축 했으면 이제 외부에서 내가 구축한 server에 접근하면 된다. 외부에서 내 server에 접근 가능하게 하기 위해서는 port forwarding을 해줘야 한다. 

단 여기서 주의할점이 하나 있다. 사설망에서 나에게 내부 IP를 부여해줄때는 DHCP(dynamic host configuration protocol) 방식으로 부여해주므로 나의 내부 IP는 네트워크에 접속 할때마다 달라진다. 따라서 접속할때마다 port forwarding을 해줘야 한다. 

<br/>

- port forwarding

사설망 IP(외부 IP) 특정 port 로 요청이 들어오면 사설망 IP에서 나에게 해당 요청을 보내주게 설정해 주는 작업.

- IP 확인하기.

내부 IP 주소는 터미널에서 'ifconfig | grep inet' 명령어를 통해서 알 수 있다. 

외부 IP 주소는 터미널에서 curl ipecho.net/plain 명령어를 통해 알 수 있다. 

<br/>

### 1-1. 외부에서 내 서버로 접속해서 브라우저에 phpinfo 띄우기

 위의 과정을 잘 설정해 주었다면 외부 네트워크에서 외부IP로 내 서버에 접속할 수 있다. 

<br/>

<br/>

## 2. AWS 서버 구축

AWS이용 linux 환경에 Nginx PHP MySQL 이용해서 서버 구축하기

<br/>

- **진행 순서**

1. AWS의 EC2를 이용해 가상 컴퓨터 할당 받기
2. AWS 인스턴스에 접속하기
3. AWS 인스터스에서 Nginx PHP MySQL 설치

<br/>

1.

일단 AWS EC2(Elastic Compute Cloud) 인스턴스를 만들어야 한다. 

이는 간단하게 생각하면 가상 서버를 빌린다고 생각하면 된다. 

<br/>

- AWS?

AWS는 Amazon Web Services의 약자로 아마존에서 운영하는 Cloud Computing Platform 이다. 

따라서 사용자는 컴퓨터에 하드웨어적인 부분은 신경을 쓰지 않아도 AWS를 이용하면 손쉽게 서버를 구축할 수 있다. 

<hr/>

<br/>

2.

첫 번째 작업을 완료했으면 이제 첫 번째 작업에서 부터 얻어온 AWS 인스턴스에 SSH 방식으로 원격 접속한다.  

<br/>

- SSH?

SSH는 Secure Shell Protol로 다른 컴퓨터와 public network를 통해 통신할 때 보안적으로 안전하게 통신하기 위해 쓰는 프로토콜이다. 

따라서 SSH를 이용해 AWS 인스턴스 서버에 안전하게 접근할 수 있다. 그리고 sftp는 ssh의 파일 전송 버전이라고 생각하면 된다. 

- Tip

Cyberduck을 이용하면 SFTP(SSH) 를 GUI 환경해서 할 수 있다. (내 로컬 컴퓨터에서 GUI 환경으로 AWS 인스턴스에 파일을 전송할 수 있다.)

<hr/>

<br/>

3.

SSH 방식으로 AWS 인스턴스에 접근했으면 이제 서버를 구축하는데 필요한 LEMP stack을 설치하면 된다. 

 [설치 과정](https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-ubuntu-18-04)

<br/>

설치하기 전에 apt 를 업데이트 해줘야 한다. 

```bash
sudo apt udate
```

그리고 apt를 이용해 Nginx를 설치한다. 

```bash
sudo apt install nginx
```

설치 후 AWS 인스턴스 서버IP로 접근하면 nginx가 제대로 설치 되어 있으면 nginx 페이지가 나온다. 또는 sudo netstat -atlpvn을 치면 nginx가 작동중인지 확인할 수 있다. 

<br/>

두 번째로 mysql을 설치했다. 

```bash
sudo apt install mysql-server
```

설치 후 ps -ef | grep mysql 을 이용하면 mysql이 설치되었음을 알 수 있다. 그리고 mysql -u root -p 명령어를 이용해 mysql에 접속할 수 있다. 

<br/>

마지막으로 php를 설치했다. 

```bash
sudo apt install php-fpm php-mysql
```

설치 후 /etc/nginx/sites-available/dafault 파일에서 

```bash
location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }
```

부분 주석을 제거해주면 nginx 와 연동된다. 

<br/>

- LEMP stack

LEMP stack은 Linux + Nginx(Engin-X) + MySQL + PHP 의 약자이다. 

- netstat

netstat은 네트워크 연결상태, 라우팅테이블, 인터페이스 상태들을 보여주는 명령어이다. 자세한 옵션이 궁금하다면 man netstat 을 이용해 알 수 있다. 

<br/>

### 2-1. 외부에서 접속하기

AWS EC2 인스턴스의 퍼블릭IP로 접근하면 서버에 접속할 수 있다. 

이때 주의해야할 점은 인스턴스의 http port를 열어주어야 브라우저를 통해 접근할 수 있다. 

<br/>

### 2-2. MySQL 외부에서 접속하기

MySQL을 외부 IP에서 접근하기 위해서는 MySQL에서 몇 가지 설정을 해줘야 한다. 

<br/>

- **과정**

1. AWS EC2 인스턴스의 mysql port 열어주기
2. MySQL에 원격 접속이 가능한 user 만들기
3. MySQL을 외부 IP에서도 접근 가능하도록 설정해주기
4. 외부에서 MySQL 접근하기

<br/>

1.

1번 과정은 aws 사이트로 가서 aws ec2 인스턴스의 보안그룹에 mysql port를 추가해주면 된다. 

<hr/>

<br/>

2.

```mysql
SELECT User, Host, authentication_string FROM mysql.user;
```

위 query를 보내면 mysql의 user들을 볼 수 있다. 이때 user은 user의 이름이고, host는 해당 mysql로 접속 가능한 IP이다. 

<br/>

mysql의 user 목록을 확인했으니 이제 외부에서 접속 가능한 user을 추가해 줘야 한다. 이때는 왠만하면 root가 아닌 user을 만드는 것이 보안상 안전하다. 

추가하는 방법은 다음과 같다. 

```mysql
CREATE USER 'hyuk'@'%' IDENTIFIED BY '원하는 비밀번호';
FLUSH PRIVILEGS;
```

위 query문이 정상적으로 적용되었으면 user 는 hyck이고 host 는  % 인 user가 mysql.user table에 추가된다.

<br/>

- host

Mysql.user table에 있는 host는 접속 가능한 IP를 의미한다. 예를 들어 host = localhost 이면 해당 user는 localhost에서만 mysql에 접속할 수 있다. 다른 예로는 host = % 이면 user는 어느 IP든지 상관 없이 mysql에 접속할 수 있다. 

<hr/>

<br/>

3.

mysql server가 실행중 일때 

```bash
sudo netstat -antp | grep mysql
```

명령어로 mysql이 어떤 IP 와 port 번호를 LISTEN 하고 있는지 알 수 있다. 보통 아무 설정도 안해주면 localhost와 3306 port를 LISTEN하고 있을 것이다. 따라서 외부에서 mysql에 접속하기 위해서는 다른 IP도 LISTEN하게 설정 파일을 바꿔줘야 한다. 

<br/>

mysql 5.7 version의 설정파일 위치는 /etc/mysql/mysql.conf.d/mysqld.cnf 이다. 여기서 bind-address 부분을 주석 처리해주거나 bind-address = 0.0.0.0 으로 바꿔주고 mysql을 다시 시작하면  mysql이 다른 IP도 LISTEN한다.

<hr/>

<br/>

4.

위 세가지 설정만 잘 해주었다면 문제 없이 접속 가능하다. 

나는 jetbrains에서 제공하는 DataGrp을 이용해 aws ec2 instance mysql에 접속하였다. 

<br/>

### 2-3. phpMyAdmin 설치

phpMyAdmin은 웹에서 mysql을 관리할 수 있게 해주는 도구이다.

<br/>

- **설치 과정 & 설치 확인**

1. phpMyAdmin 설치
2. Nginx 에서 phpMyAdmin 관련 설정하기
3. 설치 확인하기 

<br/>

1.

설치 전 apt를 update 해주고 설치를 진행하면 된다. 

```bash
sudo apt update
sudo apt install phpmyadmin
```

설치 중 어떤 서버에서 돌아갈지, 데이터베이스 설정을 자동으로 변경할지를 물어본다. 이건 상황에 맞게 설정해 주면 된다. 

<hr/>

<br/>

2.

phpMyAdmin을 설치를 완료했으면 nginx가 phpmyAdmin 파일을 찾을 수 있게 symbolic link를 해줘야 한다. 

```bash
sudo ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin
```

위와 같이 nginx에서 phpmyadmin 파일을 찾을 수 있게 링크 해주면 이제 nginx를 통해 phpmyadmin을 이용할 수 있다. 

<br/>

- 내가 한 실수

나는 1, 2번 과정을 수행 한뒤 nginx를 이용해 phpmyadmin을 이용하려고 했는데 403 error가 발생했다. 이는 경로는 맞지만 해당 파일을 불러오지 못할때 발생하는 에러다. 

열심히 이유 찾아봤더니 내가 /etc/nginx/sites-avaiable/default 에 index.php가 없어서 에러가 발생한 것이였다. 

<hr/>

<br/>

3.

브라우저에서 http://aws ec2 instance public IP/phpmyadmin/ 로 이동했을 때 제대로 phpMyAdmin 화면이 보이면 설치가 성공적으로 이루어진 것이다. 

phpMyAdmin은 DB에 접근하기 때문에 보안이 중요하다. 하지만 나는 aws ec2 보안그룹에서 설정을 해줘 다른 보안 설정은 하지 않았다. 

<br/>

### 2-4. Domain 적용

- Domain

Domain은 IP를 주소를 숫자 대신에 사람들이 보기 편하고 기억하기 쉽게 바꿔 표현한 것을 의미한다. 그예로는 www.naver.com이 있다. 

<br/>

- **진행 순서**

1. 도메인 구입하기
2. 구입한 도메인을 네임서버에 등록하기
3. 잘 연결되었나 테스트하기

<br/>

1.

도메인을 구입하기 위해서는 도매인 등록 대행 서비스를 이용해야 한다. 나는 도메인 등록 대행 서비스를 제공해주는 회사중 유명한 회사인 가비아를 통해 도메인을 구입했다. 

구입 방법은 어렵지 않다. 가비아 홈페이지에 들어가 내가 쓰고 싶은 도메인을 구입하면 된다. 

<hr/>

<br/>

2.

2번 과정은 'AWS EC2에서 실행중인 웹 서버를 구매한 도매인과 연결하기'를 찾아보면 알 수 있다. 

이 과정을 이해하기 위해서는 domain의 원리를 알아야 한다. 

