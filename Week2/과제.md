# 2주 차 과제

<br/>

## 1. Local server 구축 

Window/MacOS 환경에서 Apache PHP MySQL (Bitnami) 이용해 local server 구축하기.

<br/>

- **진행 순서** 

1. bitnami 이용 mapm 설치하기
2. port forwarding 하기 

<br/>

1.

일단 local server를 구축하기 위해서 bitnami에서 제공하는 mapm(macOS, apache, php, mysql)을 설치해야 한다. 

설치 과정은 어렵지 않았다. [설치 링크](https://bitnami.com/stack/mamp/installer) 링크로 들어가 mapm을 원하는 version을 다운로드해서 설치하면 된다. 실치가 완료되면 apache와 mysql을 시작하면 local server가 구축된다. 

<br/>

- bitnami?

bitnami는 다양한 환경에서 애플리케이션을 설치, 배포, 유지하기 위한 통합 설치 패키지를 제공하는 회사이다. 그리고 이런 통합 설치 패키지를 스택이라고 부른다. 

<hr/>

<br/>

2.

Local server을 구축했으면 이제 외부에서 내가 구축한 server에 접근하면 된다. 외부에서 내 server에 접근 가능하게 하기 위해서는 port forwarding을 해줘야 한다. 

단 여기서 주의할 점이 하나 있다. 사설망에서 나에게 내부 IP를 부여해 줄 때는 DHCP(dynamic host configuration protocol) 방식으로 부여해 주므로 나의 내부 IP는 네트워크에 접속할 때마다 달라진다. 따라서 접속할 때마다 port forwarding을 해줘야 한다. 

<br/>

- port forwarding

사설망 IP(외부 IP) 특정 port 로 요청이 들어오면 사설망 IP에서 나에게 해당 요청을 보내주게 설정해 주는 작업.

- IP 확인하기.

내부 IP 주소는 터미널에서 'ifconfig | grep inet' 명령어를 통해서 알 수 있다. 

외부 IP 주소는 터미널에서 curl ipecho.net/plain 명령어를 통해 알 수 있다. 

<br/>

### 1-1. 외부에서 내 서버로 접속해서 브라우저에 phpinfo 띄우기

 위의 과정을 잘 설정해 주었다면 외부 네트워크에서 외부 IP로 내 서버에 접속할 수 있다. 

<br/>

<br/>

## 2. AWS 서버 구축

AWS 이용 linux 환경에 Nginx PHP MySQL 이용해서 서버 구축하기

<br/>

- **진행 순서**

1. AWS의 EC2를 이용해 가상 서버 할당 받기
2. AWS 인스턴스에 접속하기
3. AWS 인스터스에서 Nginx PHP MySQL 설치

<br/>

1.

일단 AWS EC2(Elastic Compute Cloud) 인스턴스를 만들어야 한다. 

이는 간단하게 생각하면 가상 서버를 빌린다고 생각하면 된다. 

<br/>

- AWS?

AWS는 Amazon Web Services의 약자로 아마존에서 운영하는 Cloud Computing Platform이다. 

따라서 사용자는 컴퓨터에 하드웨어적인 부분은 신경을 쓰지 않아도 AWS를 이용하면 손쉽게 서버를 구축할 수 있다. 

<hr/>

<br/>

2.

첫 번째 작업을 완료했으면 이제 첫 번째 작업에서부터 얻어온 AWS 인스턴스에 SSH 방식으로 원격 접속한다.  

<br/>

- SSH?

SSH는 Secure Shell Protol로 다른 컴퓨터와 public network를 통해 통신할 때 키를 이용해 보안적으로 안전하게 통신하는 프로토콜이다.

따라서 SSH를 이용하면 AWS 인스턴스 서버에 안전하게 접근할 수 있다. 그리고 sftp는 ssh의 파일 전송 버전이라고 생각하면 된다. 

- Tip

Cyberduck을 이용하면 SFTP(SSH)를 GUI 환경해서 할 수 있다. (내 로컬 컴퓨터에서 GUI 환경으로 AWS 인스턴스에 파일을 전송할 수 있다.)

<hr/>

<br/>

3.

SSH로 AWS 인스턴스에 접근했으면 이제 서버를 구축하는데 필요한 LEMP stack을 설치하면 된다. 

 [설치 과정](https://www.digitalocean.com/community/tutorials/how-to-install-linux-nginx-mysql-php-lemp-stack-ubuntu-18-04)

<br/>

설치하기 전에 apt 를 업데이트 해줘야 한다. 

```bash
sudo apt udate
```

그리고 apt를 이용해 Nginx를 설치한다. 

```bash
sudo apt install nginx
```

설치 후 AWS 인스턴스 서버의 IP로 접근하면 nginx가 제대로 설치되어 있으면 nginx 페이지가 나온다. 또는 sudo netstat -atlpvn을 치면 nginx가 작동 중인지 확인할 수 있다. 

<br/>

두 번째로 mysql을 설치했다. 

```bash
sudo apt install mysql-server
```

설치 후 ps -ef | grep mysql 을 이용하면 mysql이 설치되었음을 알 수 있다. 그리고 mysql -u root -p 명령어를 이용해 mysql에 접속할 수 있다. 

<br/>

마지막으로 php를 설치했다. 

```bash
sudo apt install php-fpm php-mysql
```

설치 후 /etc/nginx/sites-available/dafault 파일에서 

```bash
location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }
```

부분 주석을 제거해주면 nginx 와 연동된다. 

<br/>

- LEMP stack

LEMP stack은 Linux + Nginx(Engin-X) + MySQL + PHP 의 약자이다. 

- netstat

netstat은 네트워크 연결 상태, 라우팅 테이블, 인터페이스 상태들을 보여주는 명령어이다. 자세한 옵션이 궁금하다면 man netstat 을 이용해 알 수 있다. 

<br/>

### 2-1. 외부에서 접속하기

AWS EC2 인스턴스의 퍼블릭IP로 접근하면 서버에 접속할 수 있다. 

이때 주의해야 할 점은 인스턴스에서 http port를 열어주어야 브라우저를 통해 접근할 수 있다. 

<br/>

### 2-2. MySQL 외부에서 접속하기

MySQL을 외부 IP에서 접근하기 위해서는 MySQL에서 몇 가지 설정을 해줘야 한다. 

<br/>

- **과정**

1. AWS EC2 인스턴스의 mysql port 열어주기
2. MySQL에 원격 접속이 가능한 user 만들기
3. MySQL을 외부 IP에서도 접근 가능하도록 설정해주기
4. 외부에서 MySQL 접근하기

<br/>

1.

1번 과정은 aws 사이트로 가서 aws ec2 인스턴스의 보안 그룹에 mysql port를 추가해 주면 된다. 

<hr/>

<br/>

2.

```mysql
SELECT User, Host, authentication_string FROM mysql.user;
```

위 query를 보내면 mysql의 user들을 볼 수 있다. 이때 user은 user의 이름이고, host는 해당 mysql로 접속 가능한 IP이다. 

<br/>

mysql의 user 목록을 확인했으니 이제 외부에서 접속 가능한 user을 추가해 줘야 한다. 이때는 웬만하면 root가 아닌 user을 만드는 것이 보안상 안전하다. 

추가하는 방법은 다음과 같다. 

```mysql
CREATE USER 'hyuk'@'%' IDENTIFIED BY '원하는 비밀번호';
FLUSH PRIVILEGS;
```

위 query 문이 정상적으로 적용되었으면 user는 hyuk이고 host는  % 인 user가 mysql.user table에 추가된다.

<br/>

- host

Mysql.user table에 있는 host는 접속 가능한 IP를 의미한다. 예를 들어 host = localhost 이면 해당 user는 localhost에서만 mysql에 접속할 수 있다. 다른 예로는 host = % 이면 user는 어느 IP든지 상관없이 mysql에 접속할 수 있다. 

<hr/>

<br/>

3.

mysql server가 실행중 일때 

```bash
sudo netstat -antp | grep mysql
```

명령어로 mysql이 어떤 IP 와 port 번호를 LISTEN 하고 있는지 알 수 있다. 보통 아무 설정도 안 해주면 localhost와 3306 port를 LISTEN 하고 있을 것이다. 따라서 외부에서 mysql에 접속하기 위해서는 다른 IP도 LISTEN 하게 설정 파일을 바꿔줘야 한다. 

<br/>

mysql 5.7 version의 설정 파일 위치는 /etc/mysql/mysql.conf.d/mysqld.cnf이다. 여기서 bind-address 부분을 주석 처리해 주거나 bind-address = 0.0.0.0으로 바꿔주고 mysql을 다시 시작하면  mysql이 다른 IP도 LISTEN 한다.

<hr/>

<br/>

4.

위 세 가지 설정만 잘 해주었다면 문제없이 접속 가능하다. 

나는 jetbrains에서 제공하는 DataGrp을 이용해 aws ec2 instance mysql에 접속하였다. 

<br/>

### 2-3. phpMyAdmin 설치

phpMyAdmin은 웹에서 mysql을 관리할 수 있게 해주는 도구이다.

<br/>

- **설치 과정 & 설치 확인**

1. phpMyAdmin 설치
2. Nginx 에서 phpMyAdmin 관련 설정하기
3. 설치 확인하기 

<br/>

1.

설치 전 apt를 update 해주고 설치를 진행하면 된다. 

```bash
sudo apt update
sudo apt install phpmyadmin
```

설치 중 어떤 서버에서 돌아갈지, 데이터베이스 설정을 자동으로 변경할지를 물어본다. 이건 상황에 맞게 설정해 주면 된다. 

<hr/>

<br/>

2.

phpMyAdmin을 설치를 완료했으면 nginx가 phpmyAdmin 파일을 찾을 수 있게 symbolic link를 해줘야 한다. 

```bash
sudo ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin
```

위와 같이 nginx에서 phpmyadmin 파일을 찾을 수 있게 링크해 주면 이제 nginx를 통해 phpmyadmin을 이용할 수 있다. 

<br/>

- 내가 한 실수

나는 1, 2번 과정을 수행한 뒤 nginx를 이용해 phpmyadmin을 이용하려고 했는데 403 error가 발생했다. 이는 경로는 맞지만 해당 파일을 불러오지 못할 때 발생하는 에러다. 

열심히 이유 찾아봤더니 내가 /etc/nginx/sites-avaiable/default에 index 옵션에 index.php가 없어서 에러가 발생한 것이었다. 

<hr/>

<br/>

3.

브라우저에서 http://'aws ec2 instance public IP'/phpmyadmin/로 이동했을 때 제대로 phpMyAdmin 화면이 보이면 설치가 성공적으로 이루어진 것이다. 

phpMyAdmin은 DB에 접근하기 때문에 보안이 중요하다. 하지만 나는 aws ec2 보안 그룹에서 설정을 해줘 다른 보안 설정은 하지 않았다. 

<br/>

### 2-4. Domain 적용

- Domain

Domain은 IP를 주소를 숫자 대신에 사람들이 보기 편하고 기억하기 쉽게 바꿔 표현한 것을 의미한다. 그예로는 www.naver.com이 있다. 

- 도메인의 구성

도메인은 컴퓨터 이름과 최상위 도메인으로 구성되어 있다. 예를 들면 www.naver.com에서 www.naver는 컴퓨터의 이름이다. 그리고 com은 최상위 도메인이다. 

<br/>

- **진행 순서**

1. 도메인 구입하기
2. 구입한 도메인을 내 서버와 연결하기
3. 연결되었나 테스트하기

<br/>

1.

도메인을 구입하기 위해서는 도매인 등록 대행 서비스를 이용해야 한다. 나는 도메인 등록 대행 서비스를 제공해 주는 회사 중 유명한 회사인 가비아를 통해 도메인을 구입했다. 

구입 방법은 어렵지 않다. 가비아 홈페이지에 들어가 내가 쓰고 싶은 도메인을 구입하면 된다. 

<br/>

- 도메인 등록 과정 

우리가 도메인 등록 대행 서비스를 이용해 도메인을 구입하면 다음과 같은 일들이 벌어진다. 

1. 우리가 구입한 도메인을 도메인 등록 대행 서비스에서 등록소에 등록한다.
2. 도메인 등록 대행 서비스에서 네임 서버를 구축한 뒤 네임서버의 주소를 등록소에게 알려주어 Top-level domain에 등록할 수 있게 한다. 

- ICANN

Root name server 대한 관리자 역할을 한다.

- Root name server

Root name server는 전 세계에 있는 Top-level DNS의 주소를 기억한다. 

예를 들어 Root name server에 com NS a.gtld-server.net 레코드는 com이라고 하는 Top-level 도메인의 네임서버는 a.gtld-server.net이라는 주소에 존재한다는 뜻을 가지고 있다. 

- Top-level domain

Top-level domain에는 해당 도메인에 대한 네임서버의 주소가 등록되어 있다. 

예를 들어 example.com NS a.iana-servers.net 레코드의 의미는 example.com 도메인의 네임 서버의 주소가 a.iana-servers.net이라는 의미이다. 

<hr/>

<br/>

2.

구입한 도메인을 내 서버 IP와 연결하기 위해서는 내가 구입한 도메인의 네임 서버에 접속해야 한다. 

보통 도메인 구매 대행 서비스를 이용하면 그곳에서 네임서버를 구축하고 관리해 주기 때문에 해당 서비스를 이용해서 네임 서버에 내 IP 주소를 등록해 주면 내가 구입한 도메인과 내 서버 IP가 연결된다. 

<hr/>

<br/>

3.

가장 쉽게 확인하는 방법은 브라우저에서 내가 구매한 도메인 이름으로 접속해 보는 것이다. 

다른 방법으로는 터미널을 이용한 방법이 있다. 

```
nslookup '도메인'
```

위 명령어를 치면 해당 도메인과 연결된 IP 주소를 확인할 수 있다. 

<br/>

- nslookup

nslookup은 name server lookup을 뜻한다.

- 도메인 접근 과정

1. 우리가 컴퓨터로 네트워크에 접속하면 자동적으로 우리가 사용할 DNS Server가 지정된다. 그리고 그 DNS Server는 root name server들의 주소를 알고 있다.
2. 우리가 도메인을 이용해 특정 IP로 접근하려고 시도하면 우리의 DNS Server는 우선적으로 root name server에게 물어본다.
3. root name server에게 받은 정보로 Top-level domain에 접근한다. 그리고 top-level domain에게서 우리가 접근하고자 하는 domain의 name server 주소를 받을 수 있다. 
4. 받은 name server 주소를 이용해 name server에 접속해 도메인과 연결되어 있는 IP의 주소를 알아낼 수 있다. 

<br/>

### 2-5. HTTPS 적용(let's encrypt)

- HTTPS

간단하게 생각하면 HTTPS는 HTTP 프로토콜에서 보안적인 면을 보완한 프로토콜이다.

이를 좀 더 자세히 보면 HTTPS는 SSL(TSL) 레이어 위에서 동작하는 프로토콜이다. 

- SSL 과 TLS

SSL 은 Secure Sockets Layer의 약자고, TSL 은 Transport Layer Security의 약자이다. 

SSL과 TLS은 같은 프로토콜이다. 둘의 차이점은 SSL이 하위 버전이고, TLS가 상위 버전이라고 생각하면 된다. 그래서 요즘에는 TLS을 사용하지만 SSL이라는 호칭이 더 많이 쓰이고 있다. 

![ssl:tls](https://user-images.githubusercontent.com/29492667/107109679-aef28300-6885-11eb-88a5-1792f7755876.png)



- let's encrpty

Let's encrpty는 사용에게 무료로 TLS 인증서를 발급해주는 비영리기괸이다. 

- certbot

certbot은 let's encrypt 인증서 발급을 자동으로 해주는 봇 프로그램이다. 

<br/>

- **진행 과정**

1. cerbot 설치
2. Nginx 설정 확인하기
3. Https 포트 열어주기
4. SSL 인증서 가져오기 
5. SSL 인증서 갱신

<br/>

1.

certbot을 apt을 이용해서 설치하면 오래된 버전이 설치된다. 따라서 레포지토리를 사용하여 설치하는 게 좋다. 

```bash
sudo add-apt-repository ppa:certbot/certbot // 레포지토리 추가
sudo apt install python-certbot-nginx // 설치
```

<hr/>

<br/>

2.

Certbot은 server_name을 보고 정보를 찾기 때문에 SSL을 자동으로 적용시키기 위해서는 server_name을 설정해 줘야 한다.

만약 내가 사용할 domain이 example.com, www.example.com이라면 server_name을 다음과 같이 설정해 줘야한다. 

```bash
// 파일 이름 : /etc/nginx/sites-available/example.com

server {
        listen 80; // listen 80 port
        root /var/www/html; // served 될 document들의 root 경로
        index index.php index.html index.htm index.nginx-debian.html; // 요청된 경로에 파일명이 없을때 nginx가 차례대로 해당 파일확인 해봄
        server_name example.com www.example.com; //어떤 도메인을 serve 할지(여기서는 www.example.com, example.com) 둘 다 연결되어 있는 경우 

        location / { // 해당 파일이 없으면 404 return 
                try_files $uri $uri/ =404;
        }

        location ~ \.php$ { // php 파일이면 php로 연결
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
        }

        location ~ /\.ht {
                deny all;
        }
}
```

Nginx 설정 파일을 수정한 뒤에는

```bash
sudo nginx -t
```

명령어를 통해서 설정파일의 타당성을 체크할 수 있다. 

<hr/>

<br/>

3.

AWS EC2 내 서버의 https 포트 열어주기 

<hr/>

<br/>

4.

만약 example.com 과 www.example.com 둘 다 ssl 인증서를 얻고 싶으면 다음과 같이 하면 된다. 

```bash
$ sudo certbot --nginx -d example.com -d www.example.com
```

--nginx 는 Nginx 을 이용한다는 것이고, -d 뒤에 있는 도메인에 ssl 인증서를 받고 싶다는 것이다. 

<br/>

위 명령어를 수행하면 certbot이 알아서 nginx 설정 파일을 수정해 주어, https로 내 도메인에 접속 가능해진다. 그리고 http 프로토콜로 들어오는 요청들을 redirect 해 https로 오게 nginx 설정 파일도 자동으로 수정해 준다. 

<hr/>

<br/>

5.

Let's encrypt 인증서는 90일 동안만 유효합니다. 따라서 90일이 지나면 인증서를 갱신해야 한다.

```bash
sudo certbot certificates
```

를 이용해 인증서의 남은 만료 기간을 볼 수 있다. 

<br/>

### 2-6. SubDomain 적용(Dev, Pod)

서브도메인은 도메인 이름 앞에 dev, prod 같이 확장자가 추가된 도메인이다. 서브도메인은 하나의 도메인에서 여러 서비스를 제공하고 싶을 때 각각 서비스를 분류해서 제공할 수 있게 도와준다. 

<br/>

- **진행 순서**

1. 가비아에 subdomain 등록
2. aws ec2 인스턴스 nginx server block에 subdomain 설정 추가
3. 확인하기.

<br/>

1.

가비아 dns 설정에 가서 사용하고자 하는 서브도메인을 레코드에 추가해 주면 된다. 

<br/>

- 배경 지식

일반적으로 naver.com이라는 도메인이 있으면 naver.com은 root domain이고 해당 도메인 앞에 www, m, blog 등을 붙여 subdomain으로 이용할 수 있다. 그리고 각각의 서브도메인은 다른 서버와 링크를 할 수도 있고 내 서버에서 다른 파일을 이용해 서버를 구성할 수도 있다. 

<hr/>

<br/>

2.

기존 nginx 설정에서 subdomain에 관한 server block을 추가해 주면 된다. 다음은 http://blog.example.com/ 서브 도메인에 대한 server block을 추가하는 예이다. 

```bash
server {
    listen 80;
    listen [::]:80;

    server_name blog.example.com; // subdomain 이름
    root /home/blog/; // subdomain의 root directory
    index index.php index.html index.htm index.nginx-debian.html;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.0-fpm.sock;
    }
}

```

<hr/>

<br/>

3.

확인하는 가장 간단한 방법은 해당 서브도메인에 브라우저를 이용해 접근하는 것이다. 만약 잘 이루어지지 않으면 nginx의 log, error 파일을 보고 무엇이 잘못되었는지 확인할 수 있다. 

Nginx log, error 파일의 위치는 /etc/nginx/nginx.conf 파일에서 경로를 볼 수 있다. 

<br/>

### 2-7. IP to Domain Redirect 하기

Nginx 설정 파일에서 IP주소로 요청이 들어오면 domain으로 요청이 가게 다음과 같이 설정을 추가하면 된다.

```bash
server{
		listen 80;
		listen [::]:80;
		
		server_name '내 server ip 주소';
		
		return 301 $scheme://'내 도메인 이름'$request_uri; // scheme 는 http, https 프로토콜 의미
}
```

